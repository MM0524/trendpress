<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrendPulse | Prioritized Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Th√™m DOMPurify cho b·∫£o m·∫≠t XSS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23A100FF'/></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --bg-color: #0F1021; --surface-color: #191a2e; --primary-color: #A100FF;
            --primary-light: #b540ff; --text-color: #e3e8f0; --text-muted-color: #8a8da0;
            --border-color: #2d2e49; --header-height: 65px;
            --success-color: #4CAF50; /* M√†u xanh l√° cho th√†nh c√¥ng */
            --danger-color: #f44336;   /* M√†u ƒë·ªè cho l·ªói/nguy hi·ªÉm */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; overflow-x: hidden; }
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease, visibility 0.5s ease; }
        .loader-overlay.loader-hidden { opacity: 0; visibility: hidden; }
        @keyframes pulse { 0% { top: 36px; left: 36px; width: 0; height: 0; opacity: 1; } 100% { top: 0px; left: 0px; width: 72px; height: 72px; opacity: 0; } }
        .loader-pulse { display: inline-block; position: relative; width: 80px; height: 80px; }
        .loader-pulse div { position: absolute; border: 4px solid var(--primary-light); opacity: 1; border-radius: 50%; animation: pulse 1.2s cubic-bezier(0, 0.2, 0.8, 1) infinite; }
        .loader-pulse div:nth-child(2) { animation-delay: -0.6s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 0 2rem; background-color: var(--bg-color); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1000; height: var(--header-height); animation: fadeIn 0.5s ease-out; }
        .logo { font-size: 1.8rem; font-weight: 700; cursor: pointer; }
        .logo-trend { color: var(--primary-light); }
        .nav-links { display: flex; gap: 1.5rem; list-style: none; }
        .nav-links a { color: var(--text-muted-color); text-decoration: none; font-weight: 500; transition: color 0.3s ease; padding-bottom: 4px; border-bottom: 2px solid transparent; }
        .nav-links a:hover { color: var(--primary-color); }
        .nav-links a.active-link { color: var(--text-color); border-bottom-color: var(--primary-color); }
        .nav-actions { position: relative; display: flex; align-items: center; gap: 0.75rem; }
        .hamburger-menu { display: none; }
        .btn { padding: 0.6rem 1.2rem; border: 1px solid transparent; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-light); }
        .btn-secondary { background: var(--surface-color); color: var(--text-muted-color); border: 1px solid var(--border-color); }
        .btn-outline { background: transparent; color: var(--primary-light); border: 1px solid var(--primary-light); font-size: 0.8rem; padding: 0.3rem 0.8rem; }
        .btn-outline:hover { background: var(--primary-light); color: white; }
        .analyze-trend-btn { margin-right: 0.5rem; }
        .main-container { display: grid; grid-template-columns: 320px 1fr; gap: 2rem; padding: 2rem; width: 100%; max-width: 1400px; margin: auto; animation: slideInUp 0.6s ease-out; }
        .for-u-container { display: grid; grid-template-columns: 1fr 350px; gap: 2rem; padding: 2rem; width: 100%; max-width: 1400px; margin: auto; animation: slideInUp 0.6s ease-out; }
        .trending-board-container { padding: 2rem; width: 100%; max-width: 1200px; margin: auto; animation: slideInUp 0.6s ease-out; }
        .demo-banner { grid-column: 1 / -1; background-color: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .trending-container, .for-u-content, .leaderboard-panel, #search-filter-panel { background-color: var(--surface-color); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); }
        .trending-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .trending-title-group { display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem; font-weight: 600; }
        .filter-buttons { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 0.75rem; /* TƒÉng kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
            margin-bottom: 2rem; 
        }
        .filter-btn { 
            background-color: var(--surface-color); 
            border: 1px solid var(--border-color); 
            color: var(--text-color); /* ƒê·ªïi m√†u ch·ªØ sang text-color */
            padding: 0.6rem 1.2rem; /* TƒÉng padding */
            border-radius: 8px; /* Bo tr√≤n g√≥c h∆°n */
            cursor: pointer; 
            font-weight: 500; /* L√†m m·ªèng ch·ªØ h∆°n m·ªôt ch√∫t */
            transition: all 0.2s ease; /* Transition m∆∞·ª£t m√† h∆°n */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Th√™m shadow nh·∫π */
        }
        .filter-btn:hover { 
            background-color: var(--border-color); /* N·ªÅn h∆°i s√°ng l√™n */
            border-color: var(--primary-light); /* Vi·ªÅn m√†u primary-light */
            color: var(--primary-light); /* Ch·ªØ m√†u primary-light */
            transform: translateY(-2px); /* N√¢ng nh·∫π n√∫t l√™n */
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* Shadow r√µ h∆°n */
        }
        .filter-btn.active { 
            background-color: var(--primary-color); 
            color: white; 
            border-color: var(--primary-color); 
            box-shadow: 0 4px 10px rgba(161,0,255,0.3); /* Shadow ƒë·∫∑c bi·ªát cho active */
        }
        .trend-card { background-color: var(--bg-color); padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 1rem; transition: transform 0.3s ease, box-shadow 0.3s ease; animation: slideInUp 0.5s ease-out forwards; opacity: 0; }
        .trend-card.animated { opacity: 1; } /* Class for animating cards */
        .trend-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        /* NEW: Added flex for header */
        .trend-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
        .trend-title { flex-grow: 1; font-size: 1.25rem; font-weight: 600; cursor: pointer; transition: color 0.3s; margin-bottom: 0.5rem; }
        .trend-title:hover { color: var(--primary-light); }
        .trend-description { margin-bottom: 1rem; color: var(--text-muted-color); }
        /* NEW: Styles for trend metadata */
        .trend-meta { font-size: 0.85rem; color: var(--text-muted-color); text-align: right; }
        .trend-meta-submitter { font-weight: 500; }
        .trend-meta-date { display: block; font-size: 0.75rem; }

        .loading-spinner { width: 20px; height: 20px; border: 2px solid rgba(161, 0, 255, 0.1); border-top: 2px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ai-status-indicator { position: fixed; top: 80px; right: 20px; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem 1rem; font-size: 0.8rem; z-index: 1001; }
        .ai-status-indicator.online { border-color: var(--success-color); color: var(--success-color); }
        .ai-status-indicator.offline { border-color: var(--danger-color); color: var(--danger-color); }
        .trend-footer { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .trend-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
        .tag { 
            padding: 0.25rem 0.75rem; 
            border-radius: 999px; 
            font-size: 0.8rem; 
            font-weight: 500; 
            transition: all 0.2s ease; /* Th√™m transition */
        }
        .tag.category { background-color: var(--primary-color); color: white; }
        .tag.hashtag { 
            background-color: var(--surface-color); 
            border: 1px solid var(--border-color); 
            color: var(--text-muted-color); 
            cursor: pointer; 
        }
        .tag.hashtag:hover { /* Hi·ªáu ·ª©ng hover cho hashtag */
            background-color: var(--border-color);
            border-color: var(--primary-light);
            color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .trend-actions { display: flex; align-items: center; gap: 1rem; }
        .btn-follow { background-color: var(--surface-color); border: 1px solid var(--border-color); color: var(--text-muted-color); }
        .btn-follow.followed { background-color: var(--primary-color); color: white; }
        #trends-footer { text-align: center; margin-top: 1.5rem; }
        .leaderboard-panel h3 { font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; }
        .leaderboard-widget { margin-bottom: 2rem; }
        .leaderboard-widget h4 { color: var(--primary-light); margin-bottom: 1rem; font-size: 1rem; font-weight: 600; }
        .leaderboard-widget ul { list-style: none; padding: 0; display: flex; flex-direction: column; gap: 0.5rem; }
        .leaderboard-widget li { background-color: var(--bg-color); padding: 0.75rem 1rem; border-radius: 6px; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: background-color 0.2s ease; cursor: pointer; }
        .leaderboard-widget li:hover { background-color: var(--border-color); }
        .view-source-btn, .btn-follow { display: none; }
        body.work-account-view .btn-follow, body.work-account-view .view-source-btn { display: inline-flex; }
        .dropdown { display: none; position: absolute; top: 110%; right: 0; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; min-width: 250px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10; }
        .dropdown.show { display: block; }
        .dropdown-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--text-color); text-decoration: none; cursor: pointer; }
        .dropdown-item:hover { background-color: var(--border-color); }
        #search-filter-panel h3 { font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        #search-input { width: 100%; background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 0.75rem; border-radius: 8px; font-size: 1rem; margin-bottom: 1.5rem; }
        #hashtag-filter { margin-top: 1rem; }
        #hashtag-filter h4 { color: var(--text-muted-color); font-size: 0.9rem; margin-bottom: 1rem; }
        #hashtag-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .hashtag-btn { 
            background-color: var(--bg-color); 
            border: 1px solid var(--border-color); 
            color: var(--text-muted-color); 
            padding: 0.25rem 0.75rem; 
            border-radius: 20px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
        }
        .hashtag-btn:hover { /* Hi·ªáu ·ª©ng hover cho hashtag buttons trong filter */
            border-color: var(--primary-light); 
            color: var(--primary-light); 
            background-color: var(--surface-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .hashtag-btn.active { 
            border-color: var(--primary-color); 
            color: var(--primary-light); 
            background-color: var(--surface-color);
        }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(15, 16, 33, 0.85); backdrop-filter: blur(5px); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--surface-color); padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; text-align: center; position: relative; border: 1px solid var(--border-color); transform: scale(0.95) translateY(10px); transition: transform 0.3s ease, opacity 0.3s ease; opacity: 0; }
        .modal-overlay.show .modal-content { transform: scale(1) translateY(0); opacity: 1; }
        .modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--text-muted-color); font-size: 1.5rem; cursor: pointer; }
        .modal-title { font-size: 1.5rem; margin-bottom: 1rem; }
        .modal-body { margin-bottom: 1.5rem; color: var(--text-muted-color); }
        /* NEW: Style for error messages */
        .modal-body.error-message { color: var(--danger-color); }

        #login-choice-modal .modal-content { max-width: 420px; }
        #login-choice-modal .modal-title { color: var(--primary-light); font-size: 1.75rem; margin-bottom: 0.5rem; }
        #login-choice-modal .modal-body { margin-bottom: 2rem; font-size: 0.9rem; }
        /* C·∫≠p nh·∫≠t c√°c n√∫t ƒëƒÉng nh·∫≠p ƒë·ªÉ ch·ªâ c√≥ SVG v√† span tr·ªëng */
        #login-choice-modal .btn-social { background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.75rem; padding: 1rem; text-align: center; font-size: 0.95rem; font-weight: 500; position: relative; }
        #login-choice-modal .btn-social:hover { border-color: var(--primary-color); background-color: #21233a; }
        #login-choice-modal .btn-social svg { position: absolute; left: 1.5rem; stroke: var(--text-muted-color); width: 20px; height: 20px; }
        .preferences-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; text-align: left; margin-bottom: 1.5rem; }
        #ai-insight-modal .modal-content { max-width: 550px; width: 90%; text-align: left; }
        #ai-insight-modal .modal-body { max-height: 70vh; overflow-y: auto; padding-right: 15px; }
        #ai-insight-modal h4 { color: var(--primary-light); margin-top: 1rem; margin-bottom: 0.5rem; }
        #ai-insight-modal ul { list-style-position: inside; padding-left: 5px; }
        #ai-insight-modal li { margin-bottom: 0.5rem; }
        .tb-header { border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .tb-search-container { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .tb-search-box { flex: 1; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem 1rem; display: flex; align-items: center; }
        .tb-search-box.compare { background-color: var(--surface-color); }
        .tb-search-box input { background: transparent; border: none; color: var(--text-color); font-size: 1rem; width: 100%; outline: none; }
        .tb-search-box.compare input::placeholder { color: var(--text-muted-color); }
        .tb-search-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; } /* Added flex-wrap */
        .tb-search-chip { background-color: var(--bg-color); border: 1px solid var(--primary-color); color: var(--primary-light); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.9rem; display: flex; align-items: center; gap: 0.25rem; }
        .tb-search-chip-remove { background: none; border: none; color: var(--text-muted-color); cursor: pointer; font-size: 1rem; margin-left: 0.5rem; }
        .tb-search-chip-remove:hover { color: var(--primary-light); }

        .tb-filters { display: flex; flex-wrap: wrap; gap: 1rem; }
        .tb-filter-select { background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem; }
        .tb-leaderboards-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1.5rem; }
        .tb-leaderboard { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; }
        .tb-leaderboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; color: var(--text-muted-color); font-size: 0.9rem; }
        .tb-leaderboard-list ol { list-style: none; padding: 0; }
        .tb-leaderboard-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); font-weight: 500; }
        .tb-leaderboard-list li:last-child { border-bottom: none; }
        .tb-leaderboard-list .rank { color: var(--text-muted-color); margin-right: 1rem; }
        .tb-leaderboard-list .term { flex-grow: 1; }
        .tb-leaderboard-list .growth { color: var(--success-color); }
        #tb-chart-container { margin-top: 2rem; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; }
        /* C·∫¨P NH·∫¨T: Gi·ªõi h·∫°n chi·ªÅu cao bi·ªÉu ƒë·ªì */
        #tb-chart-container canvas { width: 100%; max-height: 350px; }
        /* NEW CHART CONTAINER STYLE */
        #user-trends-chart-container {
            margin-top: 2rem;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }
        #user-trends-chart-container canvas {
            width: 100%;
            max-height: 350px;
        }


        .footer { background-color: var(--surface-color); border-top: 1px solid var(--border-color); padding: 3rem 0 1rem 0; }
        .footer-content { max-width: 1200px; margin: 0 auto; padding: 0 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; }
        .footer-title { color: var(--primary-light); font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; }
        .footer-links { list-style: none; padding: 0; }
        .footer-links a { color: var(--text-muted-color); text-decoration: none; }
        .footer-links a:hover { color: var(--primary-light); }
        .footer-bottom { border-top: 1px solid var(--border-color); margin-top: 2rem; padding-top: 1.5rem; text-align: center; color: var(--text-muted-color); font-size: 0.9rem; }
        @media (max-width: 1024px) { .main-container, .for-u-container { grid-template-columns: 1fr; } #search-filter-panel, .leaderboard-panel { grid-row: 1; }
            /* NEW: Adjust dropdown position for smaller screens */
            .nav-actions .dropdown { right: 1rem; left: auto; }
        }
        @media (max-width: 768px) {
            .header { padding: 0 1rem; }
            .nav-links { position: fixed; top: var(--header-height); left: 0; width: 100%; height: calc(100vh - var(--header-height)); background-color: var(--bg-color); flex-direction: column; align-items: center; padding-top: 2rem; transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
            nav.nav-active .nav-links { transform: translateX(0); }
            .hamburger-menu { display: flex; flex-direction: column; justify-content: space-around; width: 2rem; height: 2rem; background: transparent; border: none; cursor: pointer; z-index: 10; }
            .hamburger-menu span { width: 2rem; height: 0.25rem; background: var(--text-color); border-radius: 10px; transition: all 0.3s linear; }
            .hamburger-menu.active span:nth-child(1) { transform: translateY(0.875rem) rotate(45deg); } /* Adjusted transform origin */
            .hamburger-menu.active span:nth-child(2) { opacity: 0; }
            .hamburger-menu.active span:nth-child(3) { transform: translateY(-0.875rem) rotate(-45deg); } /* Adjusted transform origin */
            .main-container, .for-u-container, .trending-board-container { padding: 1rem; }
            .trending-title-group { font-size: 1.25rem; }
            .trend-card { padding: 1rem; }
            .trend-title { font-size: 1.1rem; }
            .tb-leaderboards-grid { grid-template-columns: 1fr; }
            .footer-content { grid-template-columns: 1fr; text-align: center; }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="loader-overlay" id="loader"><div class="loader-pulse"><div></div><div></div></div></div>
    <header class="header">
        <div class="logo" id="logo"><span class="logo-trend">Trend</span>Pulse</div>
        <div class="ai-status-indicator" id="ai-status-indicator"><span id="ai-status-text"></span></div>
        <nav id="main-nav">
            <ul class="nav-links">
                <li><a href="#" id="nav-top-trends"></a></li>
                <li><a href="#" id="nav-trending-board"></a></li>
                <li id="nav-for-u" class="hidden"><a href="#"></a></li>
                <li><a href="#" id="nav-about"></a></li>
            </ul>
        </nav>
        <div style="display: flex; align-items: center; gap: 1rem;">
             <div class="nav-actions">
                <div class="language-switcher"><button class="btn btn-outline" id="language-toggle">VN</button></div>
                <button class="btn btn-primary" id="sign-in-btn"></button>
                <div id="user-menu" class="hidden">
                    <button class="btn btn-secondary" id="user-email-btn"></button>
                    <div class="dropdown" id="user-dropdown">
                        <div class="dropdown-header" id="dropdown-user-email"></div>
                        <a href="#" class="dropdown-item" id="dropdown-work-school"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg><span></span></a>
                        <a href="#" class="dropdown-item" id="dropdown-sign-out"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg><span></span></a>
                    </div>
                </div>
            </div>
            <button class="hamburger-menu" id="hamburger-menu"><span></span><span></span><span></span></button>
        </div>
    </header>
    
    <main class="main-container" id="main-view-container">
        <aside id="search-filter-panel">
            <h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg><span id="search-filter-title"></span></h3>
            <input type="text" id="search-input" placeholder="">
            <div id="hashtag-filter">
                <h4></h4>
                <div id="hashtag-list"></div>
            </div>
        </aside>
        <section class="trending-container">
            <div class="demo-banner"><h2></h2><p></p></div>
            <div class="trending-header">
                <div class="trending-title-group"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span id="trending-header-text"></span></div>
                 <button class="btn btn-secondary hidden" id="clear-filter-btn"></button>
            </div>
            <div class="filter-buttons" id="filter-buttons"></div>
            <div id="trends-list"></div>
            <div id="trends-footer"><button class="btn btn-primary" id="load-more-btn"></button></div>
        </section>
    </main>

    <section class="for-u-container hidden" id="for-u-view-container">
        <div class="for-u-content">
            <div class="trending-header">
                <div class="trending-title-group"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg><span></span></div>
            </div>
            <div id="for-u-trends-list"></div>
            <div id="for-u-trends-footer"><button class="btn btn-primary" id="for-u-load-more-btn"></button></div>
        </div>
        <aside class="leaderboard-panel" id="for-u-leaderboard-panel">
             <h3></h3><div id="for-u-leaderboards"></div>
        </aside>
    </section>

    <section class="trending-board-container hidden" id="trending-board-view-container">
        <h2 id="tb-main-title" style="font-size: 2rem; margin-bottom: 1.5rem;"></h2>
        <div class="tb-header">
            <div class="tb-search-container" id="tb-search-container">
                <div class="tb-search-box">
                    <input type="text" id="tb-search-input" placeholder="">
                </div>
                <div class="tb-search-box compare">
                    <input type="text" id="tb-compare-input" placeholder="">
                </div>
            </div>
            <div class="tb-search-chips hidden" id="tb-search-chips-container"></div>
            <div class="tb-filters">
                <select id="tb-region-filter" class="tb-filter-select">
                    <!-- Options will be populated by JS -->
                </select>
                <select id="tb-timeframe-filter" class="tb-filter-select">
                    <!-- Options will be populated by JS -->
                </select>
                <select id="tb-category-filter" class="tb-filter-select">
                    <!-- Options will be populated by JS -->
                </select>
            </div>
        </div>
        <div id="tb-default-view">
            <div class="tb-leaderboards-grid">
                <div class="tb-leaderboard">
                    <div class="tb-leaderboard-header" id="tb-topic-list-header"><span></span> <span></span></div>
                    <div class="tb-leaderboard-list" id="tb-topic-list"></div>
                </div>
                <div class="tb-leaderboard">
                    <div class="tb-leaderboard-header" id="tb-query-list-header"><span></span> <span></span></div>
                    <div class="tb-leaderboard-list" id="tb-query-list"></div>
                </div>
            </div>
        </div>
        <div id="tb-chart-container">
            <h4 id="tb-chart-title"></h4>
            <canvas id="hot-trends-chart"></canvas>
        </div>
        <!-- NEW: Container for User's Favorite Categories Chart -->
        <div id="user-trends-chart-container" class="hidden">
            <h4 id="user-trends-chart-title"></h4>
            <canvas id="user-trends-chart"></canvas>
        </div>
    </section>

    <div class="modal-overlay" id="preferences-modal"><div class="modal-content"><button class="modal-close" data-close="preferences-modal">&times;</button><h3 class="modal-title"></h3><p class="modal-body"></p><div class="preferences-grid" id="preferences-grid"></div><div class="modal-actions"><button class="btn btn-primary" id="save-preferences-btn"></button></div></div></div>
    <div class="modal-overlay" id="premium-modal"><div class="modal-content"><button class="modal-close" data-close="premium-modal">&times;</button><h3 class="modal-title"></h3><p class="modal-body"></p><div class="modal-actions"><button class="btn btn-primary" id="premium-login-btn"></button></div></div></div>
    <div class="modal-overlay" id="login-choice-modal"><div class="modal-content"><button class="modal-close" data-close="login-choice-modal">&times;</button><h3 class="modal-title"></h3><p class="modal-body"></p><div class="modal-actions">
        <!-- C·∫¨P NH·∫¨T HTML: Th√™m ID cho span v√† lo·∫°i b·ªè vƒÉn b·∫£n ti·∫øng Anh c·ª©ng nh·∫Øc -->
        <button class="btn-social" id="login-google-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg><span id="login-google-text"></span></button>
        <button class="btn-social" id="login-work-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg><span id="login-work-text"></span></button>
    </div></div></div>
    <div class="modal-overlay" id="ai-insight-modal"><div class="modal-content"><button class="modal-close" data-close="ai-insight-modal">&times;</button><h3 class="modal-title" id="ai-insight-title"></h3><div id="ai-insight-body" class="modal-body"></div></div></div>
    <div class="modal-overlay" id="about-modal"><div class="modal-content"><button class="modal-close" data-close="about-modal">&times;</button><h3 class="modal-title"></h3><p class="modal-body"></p></div></div>
    
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section"><h4 class="footer-title">TrendPulse</h4><p class="footer-description"></p></div>
            <div class="footer-section"><h4 class="footer-title"></h4><ul class="footer-links"><li><a href="#" id="footer-top-trends"></a></li><li><a href="#" id="footer-trending-board"></a></li><li><a href="#" id="footer-about"></a></a></li></ul></div>
            <div class="footer-section"><h4 class="footer-title"></h4><ul class="footer-links"><li><span id="feat-ai-analysis"></span></li><li><span id="feat-trend-prediction"></span></li><li><span id="feat-leaderboards"></span></li><li><span id="feat-personal-recommendations"></span></li></ul></div>
            <div class="footer-section"><h4 class="footer-title"></h4><div class="footer-contact"><p id="contact-email"></p><p id="contact-support"></p></div></div>
        </div>
        <div class="footer-bottom"><p></p></div>
    </footer>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & DATA ---
        let user = { isLoggedIn: false, email: null, accountType: null, preferences: [], hasSetPreferences: false, followedTrends: [], tbSearchTerms: [] };
        const TRENDS_PER_PAGE = 5;
        let displayedTrends = { main: 0, forU: 0 };
        let currentFilter = { type: 'category', value: 'All', searchTerm: '', hashtag: '' };
        let currentView = localStorage.getItem('currentView') || 'main';
        let hotTrendsChart = null;
        let analysisChart = null;
        let userTrendsChart = null;
        let allTrends = []; // This will now hold trends fetched for the *current main/TB view* after filtering
        let masterTrendsList = []; // NEW: Cache for *all* trends fetched from backend (e.g., 12m, global, all categories)
        let categories = []; // Categories derived from masterTrendsList
        let currentLanguage = localStorage.getItem('lang') || 'vi';

        // Helper for debouncing function calls
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        const translations = {
            vi: {
                'Top Trends': 'Top Trends', 'Trending Board': 'Trending Board', 'For U': 'D√†nh cho b·∫°n', 'For You': 'D√†nh cho b·∫°n', 'About': 'Gi·ªõi thi·ªáu', 'Sign In': 'ƒêƒÉng nh·∫≠p', 'Sign Out': 'ƒêƒÉng xu·∫•t',
                'Sign in with Work/School': 'ƒêƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n c√¥ng vi·ªác/tr∆∞·ªùng h·ªçc', 'Sign in with Google': 'ƒêƒÉng nh·∫≠p v·ªõi Google',
                'Welcome to TrendPulse': 'Ch√†o m·ª´ng ƒë·∫øn v·ªõi TrendPulse', 'Discover what‚Äôs next. Act before the rest.': 'Kh√°m ph√° t∆∞∆°ng lai. H√†nh ƒë·ªông tr∆∞·ªõc ƒë·ªëi th·ªß.', 'Trending Now': 'Xu h∆∞·ªõng hi·ªán t·∫°i',
                'Show All Trends': 'Hi·ªÉn th·ªã t·∫•t c·∫£ xu h∆∞·ªõng', 'Load More': 'T·∫£i th√™m', 'View Source': 'Xem ngu·ªìn', 'Following': 'ƒêang theo d√µi', '‚ù§Ô∏è Follow': '‚ù§Ô∏è Theo d√µi', 'üîç Analyze': 'üîç Ph√¢n t√≠ch',
                'Welcome! Set Your Preferences': 'Ch√†o m·ª´ng! Thi·∫øt l·∫≠p s·ªü th√≠ch c·ªßa b·∫°n', "Select the categories you're interested in for a personalized experience.": 'Ch·ªçn c√°c danh m·ª•c b·∫°n quan t√¢m ƒë·ªÉ c√≥ tr·∫£i nghi·ªám c√° nh√¢n h√≥a.', 'Save Preferences': 'L∆∞u s·ªü th√≠ch', 'Premium Access Required': 'Y√™u c·∫ßu quy·ªÅn truy c·∫≠p Premium',
                'Please sign in with a company or school email to view the Trending Board.': 'Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng email c√¥ng ty ho·∫∑c tr∆∞·ªùng h·ªçc ƒë·ªÉ xem Trending Board.', 'Log In': 'ƒêƒÉng nh·∫≠p', 'Choose an account to continue to TrendPulse.': 'Ch·ªçn t√†i kho·∫£n ƒë·ªÉ ti·∫øp t·ª•c v·ªõi TrendPulse.',
                'Trending Board Dashboard': 'B·∫£ng ƒëi·ªÅu khi·ªÉn Trending Board', 'Top 5 Hot Trends': 'Top 5 Xu H∆∞·ªõng N√≥ng Nh·∫•t', 'Your Followed Trends': 'Xu H∆∞·ªõng B·∫°n Theo D√µi', 'Category Leaderboards': 'B·∫£ng x·∫øp h·∫°ng danh m·ª•c', 'About TrendPulse': 'Gi·ªõi thi·ªáu TrendPulse',
                "A crowdsourced platform to predict, visualize, and analyze emerging trends. Click a trend's title to get AI-powered insights.": 'N·ªÅn t·∫£ng c·ªông ƒë·ªìng ƒë·ªÉ d·ª± ƒëo√°n, tr·ª±c quan h√≥a v√† ph√¢n t√≠ch xu h∆∞·ªõng m·ªõi n·ªïi. Nh·∫•p v√†o ti√™u ƒë·ªÅ xu h∆∞·ªõng ƒë·ªÉ c√≥ th√¥ng tin chi ti·∫øt t·ª´ AI.',
                'Footer Description': 'N·ªÅn t·∫£ng ph√¢n t√≠ch v√† d·ª± ƒëo√°n xu h∆∞·ªõng h√†ng ƒë·∫ßu, gi√∫p b·∫°n n·∫Øm b·∫Øt nh·ªØng thay ƒë·ªïi m·ªõi nh·∫•t trong th·∫ø gi·ªõi s·ªë.', 'Quick Links': 'Li√™n k·∫øt nhanh', 'Features': 'T√≠nh nƒÉng', 'AI Analysis': 'Ph√¢n t√≠ch AI', 'Trend Prediction': 'D·ª± ƒëo√°n xu h∆∞·ªõng', 'Leaderboards': 'B·∫£ng x·∫øp h·∫°ng', 'Personal Recommendations': 'G·ª£i √Ω c√° nh√¢n', 'Contact': 'Li√™n h·ªá', 'Email: info@trendpulse.com': 'Email: info@trendpulse.com', 'Support: support@trendpulse.com': 'H·ªó tr·ª£: support@trendpulse.com', 'All rights reserved.': 'T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.',
                'AI: Checking...': 'AI: ƒêang ki·ªÉm tra...', 'AI: Ready': 'AI: S·∫µn s√†ng', 'AI: Unavailable': 'AI: Kh√¥ng kh·∫£ d·ª•ng', 'AI: Connection error': 'AI: L·ªói k·∫øt n·ªëi', 'AI Insight for': 'AI Insight cho', 'AI Analysis Summary for': 'T√≥m t·∫Øt Ph√¢n t√≠ch AI cho', 'AI Deep Dive for': 'Ph√¢n t√≠ch Chuy√™n s√¢u cho', 'Analyzing trend...': 'ƒêang ph√¢n t√≠ch xu h∆∞·ªõng...', 'Unable to analyze trend.': 'Kh√¥ng th·ªÉ ph√¢n t√≠ch xu h∆∞·ªõng.', 'Trends for': 'Xu h∆∞·ªõng cho', 'Success Score': 'T·ª∑ L·ªá Th√†nh C√¥ng', 'Summary': 'T√≥m T·∫Øt', 'Interest Over Time': 'M·ª©c ƒê·ªô Quan T√¢m', 'Engagement': 'T∆∞∆°ng t√°c', 'Find Trends': 'T√¨m & L·ªçc Trends', 'Popular Tags': 'Th·∫ª Ph·ªï Bi·∫øn', 'Trending Topics': 'Ch·ªß ƒë·ªÅ t√¨m ki·∫øm', 'Trending Queries': 'C·ª•m t·ª´ t√¨m ki·∫øm', 'Growth': 'Gia tƒÉng', 'All Categories': 'T·∫•t c·∫£ danh m·ª•c',
                'Search by keyword...': 'T√¨m ki·∫øm theo t·ª´ kh√≥a...', 'Add search term': 'Th√™m c·ª•m t·ª´ t√¨m ki·∫øm', '+ Compare': '+ So s√°nh',
                'Vietnam': 'Vi·ªát Nam', 'United States': 'Hoa K·ª≥', 'Global': 'To√†n c·∫ßu',
                'Last 12 months': '12 th√°ng qua', 'Last 30 days': '30 ng√†y qua', 'Last 7 days': '7 ng√†y qua',
                'Rising': 'ƒê·ªôt ph√°', 'No trends found.': 'Kh√¥ng t√¨m th·∫•y xu h∆∞·ªõng n√†o.',
                'No Title Available': 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ',
                'No Description Available': 'Kh√¥ng c√≥ m√¥ t·∫£',
                'Technology': 'C√¥ng ngh·ªá', 'Fashion': 'Th·ªùi trang', 'Gaming': 'Tr√≤ ch∆°i', 'Finance': 'T√†i ch√≠nh', 'Health': 'S·ª©c kh·ªèe', 'Travel': 'Du l·ªãch', 'Food': '·∫®m th·ª±c', 'AI': 'Tr√≠ tu·ªá nh√¢n t·∫°o', 'News': 'Tin t·ª©c', 'Science': 'Khoa h·ªçc', 'Music': '√Çm nh·∫°c', 'Media': 'Truy·ªÅn th√¥ng', 'Entertainment': 'Gi·∫£i tr√≠', 'Sports': 'Th·ªÉ thao', 'Logistics': 'Logistics', 'Cybersecurity': 'An ninh m·∫°ng', 'Healthcare': 'ChƒÉm s√≥c s·ª©c kh·ªèe', 'Education': 'Gi√°o d·ª•c', 'Environment': 'M√¥i tr∆∞·ªùng', 'Politics': 'Ch√≠nh tr·ªã', 'Marketing': 'Ti·∫øp th·ªã',
                'General': 'Chung', 'Toys': 'ƒê·ªì ch∆°i', 'Sneakers': 'Gi√†y th·ªÉ thao', 'Beauty': 'L√†m ƒë·∫πp', 'Lifestyle': 'Phong c√°ch s·ªëng', 'Family': 'Gia ƒë√¨nh', 'Cars': '√î t√¥', 'Archaeology': 'Kh·∫£o c·ªï h·ªçc', 
                'Your Favorite Trends - Interest Over Time': 'Xu h∆∞·ªõng y√™u th√≠ch c·ªßa b·∫°n - M·ª©c ƒë·ªô quan t√¢m theo th·ªùi gian'
            },
            en: {
                'Top Trends': 'Top Trends', 'Trending Board': 'Trending Board', 'For U': 'For U', 'For You': 'For You', 'About': 'About', 'Sign In': 'Sign In', 'Sign Out': 'Sign Out',
                'Sign in with Work/School': 'Sign in with Work/School', 'Sign in with Google': 'Sign in with Google',
                'Welcome to TrendPulse': 'Welcome to TrendPulse', 'Discover what‚Äôs next. Act before the rest.': 'Discover what‚Äôs next. Act before the rest.', 'Trending Now': 'Trending Now',
                'Show All Trends': 'Show All Trends', 'Load More': 'Load More', 'View Source': 'View Source', 'Following': 'Following', '‚ù§Ô∏è Follow': '‚ù§Ô∏è Follow', 'üîç Analyze': 'üîç Analyze',
                'Welcome! Set Your Preferences': 'Welcome! Set Your Preferences', "Select the categories you're interested in for a personalized experience.": "Select the categories you're interested in for a personalized experience.", 'Save Preferences': 'Save Preferences', 'Premium Access Required': 'Premium Access Required',
                'Please sign in with a company or school email to view the Trending Board.': 'Please sign in with a company or school email to view the Trending Board.', 'Log In': 'Log In', 'Choose an account to continue to TrendPulse.': 'Choose an account to continue to TrendPulse.',
                'Trending Board Dashboard': 'Trending Board Dashboard', 'Top 5 Hot Trends': 'Top 5 Hot Trends', 'Your Followed Trends': 'Your Followed Trends', 'Category Leaderboards': 'Category Leaderboards', 'About TrendPulse': 'About TrendPulse',
                "A crowdsourced platform to predict, visualize, and analyze emerging trends. Click a trend's title to get AI-powered insights.": "A crowdsourced platform to predict, visualize, and analyze emerging trends. Click a trend's title to get AI-powered insights.",
                'Footer Description': 'A leading platform for trend analysis and prediction, helping you stay ahead of the curve in the digital world.', 'Quick Links': 'Quick Links', 'Features': 'Features', 'AI Analysis': 'AI Analysis', 'Trend Prediction': 'Trend Prediction', 'Leaderboards': 'Leaderboards', 'Personal Recommendations': 'Personal Recommendations', 'Contact': 'Contact', 'Email: info@trendpulse.com': 'Email: info@trendpulse.com', 'Support: support@trendpulse.com': 'Support: support@trendpulse.com', 'All rights reserved.': 'All rights reserved.',
                'AI: Checking...': 'AI: Checking...', 'AI: Ready': 'AI: Ready', 'AI: Unavailable': 'AI: Unavailable', 'AI: Connection error': 'AI: Connection error', 'AI Insight for': 'AI Insight for', 'AI Analysis Summary for': 'AI Analysis Summary for', 'AI Deep Dive for': 'AI Deep Dive for', 'Analyzing trend...': 'Analyzing trend...', 'Unable to analyze trend.': 'Unable to analyze trend.', 'Trends for': 'Trends for', 'Success Score': 'Success Score', 'Summary': 'Summary', 'Interest Over Time': 'Interest Over Time', 'Engagement': 'Engagement', 'Find Trends': 'Find & Filter Trends', 'Popular Tags': 'Popular Tags', 'Trending Topics': 'Trending Topics', 'Trending Queries': 'Trending Queries', 'Growth': 'Growth', 'All Categories': 'All Categories',
                'Search by keyword...': 'Search by keyword...', 'Add search term': 'Add search term', '+ Compare': '+ Compare',
                'Vietnam': 'Vietnam', 'United States': 'United States', 'Global': 'Global',
                'Last 12 months': 'Last 12 months', 'Last 30 days': 'Last 30 days', 'Last 7 days': 'Last 7 days',
                'Rising': 'Rising', 'No trends found.': 'No trends found.',
                'No Title Available': 'No Title Available',
                'No Description Available': 'No Description Available',
                'Technology': 'Technology', 'Fashion': 'Fashion', 'Gaming': 'Gaming', 'Finance': 'Finance', 'Health': 'Health', 'Travel': 'Travel', 'Food': 'Food', 'AI': 'AI', 'News': 'News', 'Science': 'Science', 'Music': 'Music', 'Media': 'Media', 'Entertainment': 'Entertainment', 'Sports': 'Sports', 'Logistics': 'Logistics', 'Cybersecurity': 'Cybersecurity', 'Healthcare': 'Healthcare', 'Education': 'Education', 'Environment': 'Environment', 'Politics': 'Politics', 'Marketing': 'Marketing',
                'General': 'General', 'Toys': 'Toys', 'Sneakers': 'Sneakers', 'Beauty': 'Beauty', 'Lifestyle': 'Lifestyle', 'Family': 'Family', 'Cars': 'Cars', 'Archaeology': 'Archaeology',
                'Your Favorite Trends - Interest Over Time': 'Your Favorite Trends - Interest Over Time'
            }
        };

        const i18nBindings = [
            { selector: '#nav-top-trends', key: 'Top Trends' }, { selector: '#nav-trending-board', key: 'Trending Board' },
            { selector: '#nav-for-u a', key: 'For U' }, { selector: '#nav-about', key: 'About' },
            { selector: '#sign-in-btn', key: 'Sign In' }, { selector: '#dropdown-sign-out span:last-child', key: 'Sign Out' },
            { selector: '#dropdown-work-school span:last-child', key: 'Sign in with Work/School' },
            { selector: '#login-google-text', key: 'Sign in with Google' },
            { selector: '#login-work-text', key: 'Sign in with Work/School' },
            { selector: '.demo-banner h2', key: 'Welcome to TrendPulse' }, { selector: '.demo-banner p', key: 'Discover what‚Äôs next. Act before the rest.' },
            { selector: '#trending-header-text', key: 'Trending Now' }, { selector: '#clear-filter-btn', key: 'Show All Trends' },
            { selector: '#load-more-btn', key: 'Load More' }, { selector: '#for-u-load-more-btn', key: 'Load More' },
            { selector: '.for-u-container .trending-title-group span', key: 'For You' },
            { selector: '#preferences-modal .modal-title', key: 'Welcome! Set Your Preferences' }, { selector: '#preferences-modal .modal-body', key: "Select the categories you're interested in for a personalized experience." },
            { selector: '#save-preferences-btn', key: 'Save Preferences' }, { selector: '#premium-modal .modal-title', key: 'Premium Access Required' },
            { selector: '#premium-modal .modal-body', key: 'Please sign in with a company or school email to view the Trending Board.' }, { selector: '#premium-login-btn', key: 'Log In' },
            { selector: '#login-choice-modal .modal-title', key: 'Sign In' }, { selector: '#login-choice-modal .modal-body', key: 'Choose an account to continue to TrendPulse.' },
            { selector: '#tb-main-title', key: 'Trending Board Dashboard' }, { selector: '#for-u-leaderboard-panel h3', key: 'Category Leaderboards' },
            { selector: '#about-modal .modal-title', key: 'About TrendPulse' }, { selector: '#about-modal .modal-body', key: "A crowdsourced platform to predict, visualize, and analyze emerging trends. Click a trend's title to get AI-powered insights." },
            { selector: '.footer-section:nth-child(1) .footer-description', key: 'Footer Description' }, { selector: '.footer-section:nth-child(2) .footer-title', key: 'Quick Links' },
            { selector: '#footer-top-trends', key: 'Top Trends' }, { selector: '#footer-trending-board', key: 'Trending Board' },
            { selector: '#footer-about', key: 'About' }, { selector: '.footer-section:nth-child(3) .footer-title', key: 'Features' },
            { selector: '#feat-ai-analysis', key: 'AI Analysis' }, { selector: '#feat-trend-prediction', key: 'Trend Prediction' },
            { selector: '#feat-leaderboards', key: 'Leaderboards' }, { selector: '#feat-personal-recommendations', key: 'Personal Recommendations' },
            { selector: '.footer-section:nth-child(4) .footer-title', key: 'Contact' }, { selector: '#contact-email', key: 'Email: info@trendpulse.com' },
            { selector: '#contact-support', key: 'Support: support@trendpulse.com' }, { selector: '#ai-insight-title', key: 'AI Insight for' },
            { selector: '#search-filter-title', key: 'Find Trends' }, { selector: '#hashtag-filter h4', key: 'Popular Tags' },
            { selector: '#tb-search-input', attr: 'placeholder', key: 'Add search term' },
            { selector: '#tb-compare-input', attr: 'placeholder', key: '+ Compare' },
            { selector: '#search-input', attr: 'placeholder', key: 'Search by keyword...' },
            { selector: '#user-trends-chart-title', key: 'Your Favorite Trends - Interest Over Time' }
        ];

        const DOM = {
            body: document.body, mainNav: document.getElementById('main-nav'), hamburgerMenu: document.getElementById('hamburger-menu'),
            logo: document.getElementById('logo'), signInBtn: document.getElementById('sign-in-btn'), userMenu: document.getElementById('user-menu'),
            userEmailBtn: document.getElementById('user-email-btn'), dropdownHeader: document.getElementById('dropdown-user-email'), userDropdown: document.getElementById('user-dropdown'),
            dropdownSignOut: document.getElementById('dropdown-sign-out'), dropdownWorkSchool: document.getElementById('dropdown-work-school'),
            navTopTrends: document.getElementById('nav-top-trends'), navTrendingBoard: document.getElementById('nav-trending-board'),
            navForU: document.getElementById('nav-for-u'), navAbout: document.getElementById('nav-about'),
            modalCloses: document.querySelectorAll('.modal-close'), mainViewContainer: document.getElementById('main-view-container'),
            forUViewContainer: document.getElementById('for-u-view-container'), trendingBoardViewContainer: document.getElementById('trending-board-view-container'),
            trendsList: document.getElementById('trends-list'), forUTrendsList: document.getElementById('for-u-trends-list'),
            loadMoreBtn: document.getElementById('load-more-btn'), forULoadMoreBtn: document.getElementById('for-u-load-more-btn'),
            filterButtonsContainer: document.getElementById('filter-buttons'), clearFilterBtn: document.getElementById('clear-filter-btn'),
            preferencesGrid: document.getElementById('preferences-grid'), savePreferencesBtn: document.getElementById('save-preferences-btn'),
            searchInput: document.getElementById('search-input'), hashtagList: document.getElementById('hashtag-list'),
            tbSearchInput: document.getElementById('tb-search-input'), tbCompareInput: document.getElementById('tb-compare-input'),
            tbCategoryFilter: document.getElementById('tb-category-filter'), tbTimeframeFilter: document.getElementById('tb-timeframe-filter'),
            tbRegionFilter: document.getElementById('tb-region-filter'),
            tbSearchChipsContainer: document.getElementById('tb-search-chips-container'),
            tbDefaultView: document.getElementById('tb-default-view'),
            tbTopicListHeader: document.getElementById('tb-topic-list-header'),
            tbQueryListHeader: document.getElementById('tb-query-list-header'),
            tbChartTitle: document.getElementById('tb-chart-title'),
            userTrendsChartContainer: document.getElementById('user-trends-chart-container'),
            userTrendsChartTitle: document.getElementById('user-trends-chart-title'),
        };

        function t(key) { return (translations[currentLanguage] && translations[currentLanguage][key]) || key; }

        function openModal(modalId) { document.getElementById(modalId).classList.add('show'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('show'); }

        async function fetchLiveTrends(filters = {}, forceRefetch = false) {
            // If the request is for the "master" list (no specific filters beyond timeframe/region for comprehensive data)
            // and we already have it (and not forcing refetch), return the cached version.
            // Consider timeframe '12m' and region 'global' and category 'All' as the default for master list.
            const isMasterListRequest = (Object.keys(filters).length === 0) ||
                                        (filters.timeframe === '12m' && filters.region === 'global' && filters.category === 'All' && !filters.searchTerm && !filters.hashtag);

            if (isMasterListRequest && masterTrendsList.length > 0 && !forceRefetch) {
                 console.log("Returning cached masterTrendsList.");
                 return masterTrendsList;
            }
            
            try {
                const params = new URLSearchParams();
                if (filters.region && filters.region !== 'global') params.append('region', filters.region);
                if (filters.category && filters.category !== 'All') params.append('category', filters.category);
                if (filters.timeframe && filters.timeframe !== 'all') params.append('timeframe', filters.timeframe);
                if (filters.searchTerm) params.append('searchTerm', filters.searchTerm);
                if (filters.hashtag) params.append('hashtag', filters.hashtag);
                
                const url = `/.netlify/functions/fetch-trends?${params.toString()}`;
                console.log("Fetching trends from:", url);

                const res = await fetch(url);
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP error! Status: ${res.status} - ${errorText}`);
                }
                const data = await res.json();
                if (!data.success) {
                    throw new Error(data.message || "Failed to fetch trends from backend.");
                }
                const fetchedTrends = (Array.isArray(data.trends)) ? preprocessTrends(data.trends) : [];

                // If this fetch was for the master list, update the cache
                if (isMasterListRequest) {
                    masterTrendsList = fetchedTrends;
                    applyTrendOrdering(); // Re-apply ordering to the master list
                }

                return fetchedTrends;
            } catch (e) {
                console.warn('Failed to fetch live trends:', e.message);
                if (DOM.trendsList) {
                    DOM.trendsList.innerHTML = `<p class="modal-body error-message" style="text-align: center;">${t('Could not load trends. Please try again later.')}: ${e.message}</p>`;
                }
                return [];
            }
        }

        async function analyzeTrendSecurely(trend, analysisType) {
            try {
                const response = await fetch('/.netlify/functions/analyze-trend', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ trend, analysisType, language: currentLanguage }) });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server function error: ${response.status} ${errorText}`);
                }
                const result = await response.json();
                if (!result.success) throw new Error(result.message || 'Analysis failed on the server');

                if (analysisType === 'summary') {
                    try { return JSON.parse(result.data); } catch (e) { console.error("Failed to parse AI summary JSON:", result.data); throw new Error("AI returned an invalid summary format."); }
                }
                const cleanHtml = DOMPurify.sanitize(result.data, { USE_PROFILES: { html: true } });
                const formatDetailedInsight = (markdownText) => markdownText
                    .replace(/### (.*?)\n/g, '<h4>$1</h4>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^\* (.*$)/gm, '<li>$1</li>')
                    .replace(/<\/li>\n/g, '</li>')
                    .replace(/(\r\n|\n|\r)/gm, '<br>')
                    .replace(/<br><br><li>/g, '<ul><li>')
                    .replace(/<\/li><br><h4>/g, '</li></ul><h4>')
                    .concat('</ul>');

                return formatDetailedInsight(cleanHtml);

            } catch (error) { console.error("Secure analysis request failed:", error); throw error; }
        }

        // UPDATED: preprocessTrends. Only calculates hotnessScore, assumes metrics exist.
        function preprocessTrends(trends) {
            if (!trends || trends.length === 0) return [];
            
            const maxValues = {
                views: Math.max(1, ...trends.map(trendItem => trendItem.views || 0)),
                interactions: Math.max(1, ...trends.map(trendItem => trendItem.interactions || 0)),
                searches: Math.max(1, ...trends.map(trendItem => trendItem.searches || 0)),
                votes: Math.max(1, ...trends.map(trendItem => trendItem.votes || 0)),
            };
            
            trends.forEach((trendItem, i) => {
                trendItem.id = trendItem.id || `temp-id-${i}`; // ID now comes from backend, this is a fallback.
                trendItem.type = trendItem.type || (i % 3 === 0 ? 'topic' : 'query');
                trendItem.hotnessScore = calculateHotnessScore(trendItem, maxValues);
            });
            return trends;
        }

        function calculateHotnessScore(trend, maxValues) {
            const weights = { views: 0.2, interactions: 0.4, searches: 0.3, votes: 0.1 };
            const normViews = (trend.views / maxValues.views) || 0;
            const normInteractions = (trend.interactions / maxValues.interactions) || 0;
            const normSearches = (trend.searches / maxValues.searches) || 0;
            const normVotes = (trend.votes / maxValues.votes) || 0;
            return (normViews * weights.views) + (normInteractions * weights.interactions) + (normSearches * weights.searches) + (normVotes * weights.votes);
        }

        function applyTranslations() {
            i18nBindings.forEach(b => {
                const el = document.querySelector(b.selector);
                if (el) {
                    if (b.attr) {
                        el.setAttribute(b.attr, t(b.key));
                    } else {
                        el.textContent = t(b.key);
                    }
                }
            });
            document.querySelector('.footer-bottom p').textContent = `¬© 2024 TrendPulse. ${t('All rights reserved.')}`;
            document.getElementById('ai-status-text').textContent = t('AI: Checking...');
            if (DOM.tbTopicListHeader && DOM.tbTopicListHeader.children[0]) DOM.tbTopicListHeader.children[0].textContent = t('Trending Topics');
            if (DOM.tbQueryListHeader && DOM.tbQueryListHeader.children[0]) DOM.tbQueryListHeader.children[0].textContent = t('Trending Queries');

            if (DOM.tbRegionFilter) {
                const currentRegion = DOM.tbRegionFilter.value;
                DOM.tbRegionFilter.innerHTML = `
                    <option value="global">${t('Global')}</option>
                    <option value="vn">${t('Vietnam')}</option>
                    <option value="us">${t('United States')}</option>
                `;
                DOM.tbRegionFilter.value = currentRegion;
            }

            if (DOM.tbTimeframeFilter) {
                const currentTimeframe = DOM.tbTimeframeFilter.value;
                DOM.tbTimeframeFilter.innerHTML = `
                    <option value="12m">${t('Last 12 months')}</option>
                    <option value="1m">${t('Last 30 days')}</option>
                    <option value="7d">${t('Last 7 days')}</option>
                `;
                DOM.tbTimeframeFilter.value = currentTimeframe;
            }

            populateCategoryFilters();
        }

        function updateLanguageToggleUI() {
            document.getElementById('language-toggle').textContent = currentLanguage === 'vi' ? 'VN' : 'EN';
        }

        function createTrendCard(trend, delay = 0) {
            if (!trend || (!trend.title_en && !trend.title_vi)) { console.error("Invalid trend data passed to createTrendCard: Missing title", trend); return document.createElement('div'); }
            const trendCard = document.createElement('div');
            trendCard.className = 'trend-card';
            trendCard.dataset.trendId = trend.id; // Uses stable hash ID from backend

            const { title: localizedTitle, description: localizedDesc } = getLocalizedTrendText(trend);
            const isFollowed = user.followedTrends.includes(trend.id); // Check if stable hash ID is in followed list

            trendCard.innerHTML = `
                <div class="trend-card-header">
                    <h3 class="trend-title">${localizedTitle}</h3>
                    <div class="trend-meta">
                        <span class="trend-meta-submitter">by ${trend.submitter || 'Anon'}</span>
                        <span class="trend-meta-date">on ${new Date(trend.date).toLocaleDateString(currentLanguage)}</span>
                    </div>
                </div>
                <p class="trend-description">${localizedDesc}</p>
                <div class="trend-footer">
                    <div class="trend-tags">
                        <span class="tag category">${t(trend.category)}</span>
                        ${(trend.tags || []).map(tag => `<span class="tag hashtag" data-tag="${tag}">#${tag}</span>`).join('')}
                    </div>
                    <div class="trend-actions">
                        <a href="${trend.source}" target="_blank" rel="noopener noreferrer" class="btn btn-outline view-source-btn">${t('View Source')}</a>
                        <button class="btn btn-outline analyze-trend-btn">${t('üîç Analyze')}</button>
                        <button class="btn btn-follow ${isFollowed ? 'followed' : ''}">${isFollowed ? t('Following') : t('‚ù§Ô∏è Follow')}</button>
                    </div>
                </div>`;
            
            setTimeout(() => trendCard.classList.add('animated'), delay);
            return trendCard;
        }

        function getVisibleTrends() {
            let sourceList = [...masterTrendsList]; // Always start filtering from the master list

            if (currentView === 'forU') {
                if (!user.isLoggedIn || user.accountType !== 'work') return [];
                const preferenceTrends = sourceList.filter(trendItem => trendItem && user.preferences.includes(trendItem.category));
                const followedTrendsData = sourceList.filter(trendItem => trendItem && user.followedTrends.includes(trendItem.id));
                const combined = [...followedTrendsData, ...preferenceTrends];
                const uniqueTrendIds = new Set(combined.map(trendItem => trendItem.id));
                return Array.from(uniqueTrendIds)
                    .map(id => sourceList.find(trendItem => trendItem.id === id))
                    .filter(Boolean)
                    .sort((a,b) => b.hotnessScore - a.hotnessScore); // Sort by hotness
            }

            // For 'main' view, filter from the master list
            if (currentFilter.type === 'category' && currentFilter.value !== 'All') {
                sourceList = sourceList.filter(trendItem => trendItem && trendItem.category === currentFilter.value);
            }
            if (currentFilter.hashtag) {
                sourceList = sourceList.filter(trendItem => trendItem && (trendItem.tags || []).includes(currentFilter.hashtag));
            }
            if (currentFilter.searchTerm) {
                const term = currentFilter.searchTerm.toLowerCase();
                sourceList = sourceList.filter(trendItem => trendItem && (
                    (trendItem.title_vi && trendItem.title_vi.toLowerCase().includes(term)) ||
                    (trendItem.description_vi && trendItem.description_vi.toLowerCase().includes(term)) ||
                    (trendItem.title_en && trendItem.title_en.toLowerCase().includes(term)) ||
                    (trendItem.description_en && trendItem.description_en.toLowerCase().includes(term))
                ));
            }
            return sourceList.filter(Boolean);
        }

        function displayTrends() {
            if (currentView === 'trendingBoard') return;

            const listElement = currentView === 'main' ? DOM.trendsList : DOM.forUTrendsList;
            const footerButton = currentView === 'main' ? DOM.loadMoreBtn : DOM.forULoadMoreBtn;
            
            allTrends = getVisibleTrends(); // allTrends is now just the *filtered* list for the current view
            
            if (!listElement) {
                console.error("Trends list element not found for current view:", currentView);
                return;
            }

            listElement.innerHTML = '';
            let trendsRendered = 0;
            const numToDisplay = Math.min(displayedTrends[currentView] || TRENDS_PER_PAGE, allTrends.length);

            if (numToDisplay === 0 && allTrends.length === 0) {
                 listElement.innerHTML = `<p class="modal-body" style="text-align: center;">${t('No trends found.')}</p>`;
            }

            for (let i = 0; i < numToDisplay; i++) {
                listElement.appendChild(createTrendCard(allTrends[i], i * 50));
                trendsRendered++;
            }

            displayedTrends[currentView] = trendsRendered;

            if (footerButton) {
                footerButton.classList.toggle('hidden', displayedTrends[currentView] >= allTrends.length);
            }

            if (currentView === 'forU') {
                generateCategoryLeaderboards('for-u-leaderboards', user.preferences.length > 0 ? user.preferences : categories.slice(0, 3));
            }
            updateClearFilterButtonVisibility();
        }

        function updateClearFilterButtonVisibility() {
            const hasActiveFilter = (currentFilter.value !== 'All' || currentFilter.searchTerm !== '' || currentFilter.hashtag !== '');
            if (DOM.clearFilterBtn) {
                DOM.clearFilterBtn.classList.toggle('hidden', !hasActiveFilter);
            }
        }

        async function clearMainViewFilters() {
            currentFilter = { type: 'category', value: 'All', searchTerm: '', hashtag: '' };
            if (DOM.searchInput) DOM.searchInput.value = '';
            if (DOM.hashtagList) DOM.hashtagList.querySelectorAll('.hashtag-btn').forEach(btn => btn.classList.remove('active'));
            
            updateUIForFilter(); // This will call displayTrends() which uses masterTrendsList
        }

        function loadMoreTrends() {
            displayedTrends[currentView] += TRENDS_PER_PAGE;
            displayTrends();
        }

        async function switchView(view) {
            currentView = view;
            localStorage.setItem('currentView', view);
            displayedTrends.main = 0;
            displayedTrends.forU = 0;

            [DOM.mainViewContainer, DOM.forUViewContainer, DOM.trendingBoardViewContainer].forEach(container => {
                if (container) container.classList.add('hidden');
            });

            if (view === 'main') {
                if (DOM.mainViewContainer) DOM.mainViewContainer.classList.remove('hidden');
            } else if (view === 'forU') {
                if (!user.isLoggedIn || user.accountType !== 'work') {
                    switchView('main');
                    openModal('premium-modal');
                    return;
                }
                if (DOM.forUViewContainer) DOM.forUViewContainer.classList.remove('hidden');
            } else if (view === 'trendingBoard') {
                if (!user.isLoggedIn || user.accountType !== 'work') {
                    switchView('main');
                    openModal('premium-modal');
                    return;
                }
                if (DOM.trendingBoardViewContainer) DOM.trendingBoardViewContainer.classList.remove('hidden');
                // Reset TB filters and search terms when entering TB view
                if (DOM.tbCategoryFilter) DOM.tbCategoryFilter.value = 'All';
                if (DOM.tbTimeframeFilter) DOM.tbTimeframeFilter.value = '12m';
                if (DOM.tbRegionFilter) DOM.tbRegionFilter.value = 'global';
                user.tbSearchTerms = [];
                if (DOM.tbSearchInput) DOM.tbSearchInput.value = '';
                if (DOM.tbCompareInput) DOM.tbCompareInput.value = '';
                
                await createHotTrendsChart(); // This will handle fetching and setting `allTrends` for TB
            }

            if (view !== 'trendingBoard') {
                displayTrends(); // Only call displayTrends for main/forU, as TB is handled by createHotTrendsChart
            }
            
            updateActiveNav(view);
            if (DOM.hamburgerMenu && DOM.mainNav.classList.contains('nav-active')) {
                DOM.hamburgerMenu.click();
            }
        }

        function updateAuthUI() {
            if (DOM.body) DOM.body.className = '';
            if (user.isLoggedIn) {
                if (DOM.body) DOM.body.classList.add('logged-in');
                if (DOM.signInBtn) DOM.signInBtn.classList.add('hidden');
                if (DOM.userMenu) DOM.userMenu.classList.remove('hidden');
                if (DOM.userEmailBtn) DOM.userEmailBtn.textContent = user.email;
                if (DOM.dropdownHeader) DOM.dropdownHeader.textContent = user.email;
                if (DOM.navForU) DOM.navForU.classList.toggle('hidden', user.accountType !== 'work');
                if (DOM.dropdownWorkSchool) DOM.dropdownWorkSchool.classList.toggle('hidden', user.accountType !== 'personal');
                if (user.accountType === 'work' && DOM.body) DOM.body.classList.add('work-account-view');
            } else {
                if (DOM.signInBtn) DOM.signInBtn.classList.remove('hidden');
                if (DOM.userMenu) DOM.userMenu.classList.add('hidden');
                if (DOM.navForU) DOM.navForU.classList.add('hidden');
                if (DOM.body) DOM.body.classList.remove('work-account-view');
            }
            displayTrends();
        }

        function signIn(type) {
            user = {
                isLoggedIn: true,
                accountType: type,
                email: type === 'personal' ? 'user@gmail.com' : 'pro@company.com',
                preferences: [],
                hasSetPreferences: false,
                followedTrends: [],
                tbSearchTerms: []
            };
            closeModal('login-choice-modal');
            updateAuthUI();
            if (type === 'work' && !user.hasSetPreferences) {
                populatePreferenceCheckboxes();
                openModal('preferences-modal');
            } else if (type === 'personal') {
                switchView('main');
            }
        }

        function populateCategoryFilters() {
            categories = [...new Set(masterTrendsList.map(trendItem => trendItem.category))].sort();
            const allOptionText = t('All Categories');
            if (DOM.filterButtonsContainer) {
                DOM.filterButtonsContainer.innerHTML = [`<button class="filter-btn ${currentFilter.value === 'All' ? 'active' : ''}" data-filter="All">${allOptionText}</button>`, ...categories.map(category => `<button class="filter-btn ${category === currentFilter.value ? 'active' : ''}" data-filter="${category}">${t(category)}</button>`)].join('');
            }

            if (DOM.tbCategoryFilter) {
                const currentCategory = DOM.tbCategoryFilter.value;
                DOM.tbCategoryFilter.innerHTML = `<option value="All">${allOptionText}</option>`;
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = t(cat);
                    DOM.tbCategoryFilter.appendChild(option);
                });
                DOM.tbCategoryFilter.value = currentCategory;
            }
        }

        function populatePreferenceCheckboxes() {
            if (DOM.preferencesGrid) {
                DOM.preferencesGrid.innerHTML = categories.map(category => `<div class="preference-item"><label><input type="checkbox" name="preference" value="${category}" ${user.preferences.includes(category) ? 'checked' : ''}> ${t(category)}</label></div>`).join('');
            }
        }

        function updateUIForFilter() {
            if (DOM.filterButtonsContainer) {
                DOM.filterButtonsContainer.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === currentFilter.value));
            }
            if (DOM.hashtagList) {
                DOM.hashtagList.querySelectorAll('.hashtag-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.hashtag === currentFilter.hashtag));
            }
            if (DOM.searchInput) DOM.searchInput.value = currentFilter.searchTerm;

            displayedTrends.main = 0;
            displayTrends();
            updateClearFilterButtonVisibility();
        }

        function populateHashtagFilters() {
            const hashtagCounts = masterTrendsList.reduce((acc, trendItem) => {
                (trendItem.tags || []).forEach(tag => { if (tag) acc[tag] = (acc[tag] || 0) + 1; });
                return acc;
            }, {});
            const popularHashtags = Object.entries(hashtagCounts).sort((a, b) => b[1] - a[1]).slice(0, 10).map(entry => entry[0]);
            if (DOM.hashtagList) {
                DOM.hashtagList.innerHTML = popularHashtags.map(tag => `<button class="hashtag-btn ${currentFilter.hashtag === tag ? 'active' : ''}" data-hashtag="${tag}">#${tag}</button>`).join('');
            }
        }

        function generateCategoryLeaderboards(containerId, categoriesToShow) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            if (user.isLoggedIn && user.followedTrends.length > 0) {
                const followedTrendsData = masterTrendsList.filter(trendItem => user.followedTrends.includes(trendItem.id));
                if (followedTrendsData.length > 0) {
                    const leaderboardDiv = document.createElement('div');
                    leaderboardDiv.className = 'leaderboard-widget';
                    const listItems = followedTrendsData.map(trendItem => `<li data-trend-id="${trendItem.id}">${truncateText(getLocalizedTrendText(trendItem).title, 35)}</li>`).join('');
                    leaderboardDiv.innerHTML = `<h4>${t('Your Followed Trends')}</h4><ul>${listItems}</ul>`;
                    container.appendChild(leaderboardDiv);
                }
            }

            const uniqueCategoriesToShow = Array.from(new Set(categoriesToShow)).sort();
            uniqueCategoriesToShow.forEach(category => {
                const trendsInCategory = masterTrendsList.filter(trendItem => trendItem.category === category);
                if (trendsInCategory.length === 0) return;
                const sortedTrends = [...trendsInCategory].sort((a, b) => b.hotnessScore - a.hotnessScore);
                const topTrends = sortedTrends.slice(0, 3);

                const leaderboardDiv = document.createElement('div');
                leaderboardDiv.className = 'leaderboard-widget';
                let listItems = topTrends.map(trendItem => `<li data-trend-id="${trendItem.id}">${truncateText(getLocalizedTrendText(trendItem).title, 35)}</li>`).join('');
                leaderboardDiv.innerHTML = `<h4>${t('Top in')} ${t(category)}</h4><ul>${listItems}</ul>`;
                container.appendChild(leaderboardDiv);
            });
        }

        function renderSummaryAnalysis(analysisData) {
            const modalBody = document.getElementById('ai-insight-body');
            if (!modalBody) return;
            modalBody.classList.remove('error-message');
            const chartData = generateChartDataFromScore(analysisData.successScore);
            modalBody.innerHTML = `
                <div style="margin-bottom: 1rem;"><h4>${t('Success Score')}</h4><p style="font-size: 2rem; font-weight: bold; color: var(--primary-light);">${analysisData.successScore.toFixed(0)}%</p></div>
                <div style="margin-bottom: 1rem;"><h4>${t('Summary')}</h4><p>${DOMPurify.sanitize(analysisData.summary)}</p></div>
                <div><h4>${t('Interest Over Time')}</h4></div>`;
            renderAnalysisChart(chartData.historicalData, chartData.futureProjection);
        }

        function renderDetailedAnalysis(htmlContent) {
            const modalBody = document.getElementById('ai-insight-body');
            if (!modalBody) return;
            modalBody.classList.remove('error-message');
            modalBody.innerHTML = htmlContent;
        }

        function renderAnalysisChart(historicalData, futureProjection) {
            const canvas = document.createElement('canvas');
            const insightBody = document.getElementById('ai-insight-body');
            if (!insightBody) {
                console.error("AI Insight body not found for chart rendering.");
                return;
            }

            if (analysisChart) analysisChart.destroy();
            
            insightBody.appendChild(canvas);
            const labels = ['-1d', '-6h', '-3h', 'Now', '+1d', '+4d', '+7d'];
            const lastHistoricalPoint = historicalData[historicalData.length - 1];
            const projectionData = [null, null, null, lastHistoricalPoint, futureProjection[0] || null, futureProjection[1] || null, futureProjection[2] || null];
            analysisChart = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: t('Historical'), data: [...historicalData, null, null, null], borderColor: '#00C8FF', tension: 0.1, pointBackgroundColor: '#00C8FF', pointBorderColor: '#fff', pointHoverRadius: 7, stepped: false },
                        { label: t('Projection'), data: projectionData, borderColor: '#A100FF', borderDash: [5, 5], tension: 0.4, pointBackgroundColor: '#A100FF', pointBorderColor: '#fff', pointHoverRadius: 7, stepped: false }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, labels: { color: '#8a8da0', usePointStyle: true, boxWidth: 8 } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatNumber(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#8a8da0' } },
                        y: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#8a8da0', callback: (v) => formatNumber(v) }, beginAtZero: true }
                    }
                }
            });
        }

        function getCombinedMetric(trend) { 
            // Use the metrics provided by backend
            return (trend.views || 0) + (trend.interactions || 0) + (trend.searches || 0); 
        }

        function getLocalizedTrendText(trend) {
            const defaultTitle = t('No Title Available');
            const defaultDescription = t('No Description Available');

            const title_vi = trend.title_vi || trend.title_en || defaultTitle;
            const description_vi = trend.description_vi || trend.description_en || defaultDescription;
            const title_en = trend.title_en || trend.title_vi || defaultTitle;
            const description_en = trend.description_en || trend.description_vi || defaultDescription;

            return currentLanguage === 'vi' ?
                { title: title_vi, description: description_vi } :
                { title: title_en, description: description_en };
        }

        function truncateText(text = '', maxLength = 180) {
            if (!text || text.length <= maxLength) return text;
            const cut = text.slice(0, maxLength);
            return cut.slice(0, cut.lastIndexOf(' ', maxLength) || maxLength) + '‚Ä¶';
        }

        function makeTrendKey(trend) { 
            // Use the stable hash ID if available, otherwise fallback (for older data perhaps)
            const id = trend.id; // Trend ID should now be stable from backend
            return `${id}|${getLocalizedTrendText(trend).title || ''}|${trend.source || ''}`.toLowerCase(); 
        }
        function loadSeenTrends() { try { return JSON.parse(localStorage.getItem('seenTrends') || '[]'); } catch { return []; } }
        function saveSeenTrendKey(key) { try { const seen = new Set(loadSeenTrends()); if (!seen.has(key)) localStorage.setItem('seenTrends', JSON.stringify([...seen, key])); } catch {} }

        // UPDATED: applyTrendOrdering now orders the master list
        function applyTrendOrdering() {
            const seenKeys = new Set(loadSeenTrends());
            const unseen = [];
            const seen = [];
            masterTrendsList.forEach(trendItem => (seenKeys.has(makeTrendKey(trendItem)) ? seen : unseen).push(trendItem));
            masterTrendsList = [...shuffleArray(unseen), ...seen];
        }

        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; }
            return arr;
        }

        function generateChartDataFromScore(score, baseMetric = 500) {
            const growthFactor = (score - 50) / 500;
            let historicalData = [baseMetric * 0.4, baseMetric * 0.7, baseMetric * 0.9, baseMetric].map(v => Math.round(v));
            let futureProjection = [];
            let lastValue = baseMetric;
            let next1d = lastValue * (1 + growthFactor * 0.2 + (Math.random() - 0.5) * 0.05);
            futureProjection.push(Math.max(0, Math.round(next1d)));
            let next4d = next1d * (1 + growthFactor * 0.1 + (Math.random() - 0.5) * 0.05);
            futureProjection.push(Math.max(0, Math.round(next4d)));
            let next7d = next4d * (1 + growthFactor * 0.05 + (Math.random() - 0.5) * 0.05);
            futureProjection.push(Math.max(0, Math.round(next7d)));
            return { historicalData, futureProjection };
        }

        function getColorPalette(count) {
            const base = [{ stroke: '#A100FF' }, { stroke: '#00C8FF' }, { stroke: '#00E696' }, { stroke: '#FFB400' }, { stroke: '#FF6384' }];
            while (base.length < count) base.push({ stroke: `hsl(${Math.random() * 360}, 90%, 60%)` });
            return base;
        }

        function formatNumber(n) { if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M'; if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K'; return String(n); }

        async function checkAIStatus() {
            try {
                const response = await fetch("/.netlify/functions/analyze-trend", { method: 'GET' });
                const statusIndicator = document.getElementById('ai-status-indicator');
                const statusText = document.getElementById('ai-status-text');
                const isOnline = response.ok;
                if (statusIndicator) statusIndicator.classList.toggle('online', isOnline);
                if (statusIndicator) statusIndicator.classList.toggle('offline', !isOnline);
                if (statusText) statusText.textContent = t(isOnline ? 'AI: Ready' : 'AI: Unavailable');
            } catch (error) {
                const statusIndicator = document.getElementById('ai-status-indicator');
                const statusText = document.getElementById('ai-status-text');
                if (statusIndicator) statusIndicator.className = 'ai-status-indicator offline';
                if (statusText) statusText.textContent = t('AI: Connection error');
                console.error('AI Status Check Failed:', error);
            }
        }

        function updateActiveNav(activeView) {
            document.querySelectorAll('#main-nav a').forEach(a => a.classList.remove('active-link'));
            if (activeView === 'main') { if (DOM.navTopTrends) DOM.navTopTrends.classList.add('active-link'); }
            else if (activeView === 'forU') { if (DOM.navForU && DOM.navForU.querySelector('a')) DOM.navForU.querySelector('a').classList.add('active-link'); }
            else if (activeView === 'trendingBoard') { if (DOM.navTrendingBoard) DOM.navTrendingBoard.classList.add('active-link'); }
            else if (activeView === 'about') { if (DOM.navAbout) DOM.navAbout.classList.add('active-link'); }
        }

        // --- Trending Board specific functions ---

        function isTrendRelevantForTimeframe(trend, timeframe) {
            if (!trend || !trend.date) return false;
            const trendDate = new Date(trend.date);
            const now = new Date();
            let cutoffDate = new Date(now);

            switch (timeframe) {
                case '7d':
                    cutoffDate.setDate(now.getDate() - 7);
                    break;
                case '1m': // 30 days
                    cutoffDate.setDate(now.getDate() - 30);
                    break;
                case '12m': // 12 months
                    cutoffDate.setFullYear(now.getFullYear() - 1);
                    break;
                default:
                    return true; // No specific time filter, all trends are relevant
            }
            trendDate.setHours(0,0,0,0);
            cutoffDate.setHours(0,0,0,0);

            return trendDate >= cutoffDate;
        }

        function generateChartLabels(timeframe) {
            const now = new Date();
            const labels = [];
            if (timeframe === '7d') {
                for (let i = 6; i >= 0; i--) { // Last 7 days including today
                    const d = new Date(now);
                    d.setDate(now.getDate() - i);
                    labels.push(d.toLocaleDateString(currentLanguage, { day: 'numeric', month: 'short' }));
                }
            } else if (timeframe === '1m') {
                for (let i = 29; i >= 0; i -= 5) { // Approximately 6 points spread over 30 days
                    const d = new Date(now);
                    d.setDate(now.getDate() - i);
                    labels.push(d.toLocaleDateString(currentLanguage, { day: 'numeric', month: 'short' }));
                }
                // Ensure the "today" point is included if not already
                if (labels.length > 0 && new Date(labels[labels.length -1]).toDateString() !== now.toDateString()) {
                    labels.push(now.toLocaleDateString(currentLanguage, { day: 'numeric', month: 'short' }));
                }
            } else { // '12m'
                for (let i = 11; i >= 0; i--) {
                    const d = new Date(now);
                    d.setMonth(now.getMonth() - i);
                    labels.push(d.toLocaleDateString(currentLanguage, { month: 'short', year: '2-digit' }));
                }
            }
            return labels;
        }

        function generateSeriesForTimeframe(trend, labels, timeframe) {
            const series = new Array(labels.length).fill(0);
            const trendDate = new Date(trend.date || Date.now());
            trendDate.setHours(0,0,0,0);
            const peakMetric = getCombinedMetric(trend); // Total engagement metric

            const now = new Date();
            now.setHours(0,0,0,0);

            labels.forEach((label, index) => {
                let currentLabelDate;
                if (timeframe === '7d' || timeframe === '1m') {
                    let datePart = new Date(now);
                    if (timeframe === '7d') {
                        datePart.setDate(now.getDate() - (labels.length - 1 - index));
                    } else if (timeframe === '1m') {
                        const daysBetweenLabels = (labels.length > 1) ? 30 / (labels.length - 1) : 0;
                        datePart.setDate(now.getDate() - Math.round((labels.length - 1 - index) * daysBetweenLabels));
                    }
                    currentLabelDate = new Date(datePart.getFullYear(), datePart.getMonth(), datePart.getDate());
                } else { // 12m
                    const parts = label.split('/');
                    const monthShort = parts[0];
                    const yearShort = parts[1];
                    const year = parseInt(`20${yearShort}`);
                    const dateForMonthParse = new Date(Date.parse(monthShort + " 1, 2000"));
                    const monthIndex = dateForMonthParse.getMonth();
                    currentLabelDate = new Date(year, monthIndex, 1);
                }
                currentLabelDate.setHours(0,0,0,0);

                if (currentLabelDate < trendDate) {
                    series[index] = 0;
                    return;
                }

                const timeDiffDaysFromTrendStart = (currentLabelDate.getTime() - trendDate.getTime()) / (1000 * 60 * 60 * 24);

                let decayRate = 0.03;
                let peakShiftDays = 3; 

                if (timeframe === '7d') {
                    decayRate = 0.8; 
                    peakShiftDays = 1; 
                } else if (timeframe === '1m') {
                    decayRate = 0.3; 
                    peakShiftDays = 3; 
                } else { // 12m
                    decayRate = 0.05; 
                    peakShiftDays = 10; 
                }
                
                const timeRelativeToPeak = timeDiffDaysFromTrendStart - peakShiftDays;
                const hotnessScale = 1 + (trend.hotnessScore || 0) * 5;
                let rawValue = peakMetric * hotnessScale * Math.exp(-decayRate * Math.pow(timeRelativeToPeak, 2) / (peakShiftDays * peakShiftDays));
                rawValue = rawValue * (1 + (Math.random() - 0.5) * 0.2);

                series[index] = Math.max(0, Math.round(rawValue));
            });

            return series;
        }

        async function renderTBDashboard(timeframe) {
            // allTrends already holds the category/region/timeframe filtered data for TB
            let trendsForLeaderboard = [...allTrends]; 

            const topics = trendsForLeaderboard.filter(trendItem => trendItem.type === 'topic').sort((a,b) => b.hotnessScore - a.hotnessScore).slice(0, 5);
            const queries = trendsForLeaderboard.filter(trendItem => trendItem.type === 'query').sort((a,b) => b.hotnessScore - a.hotnessScore).slice(0, 5);

            const tbTopicList = document.getElementById('tb-topic-list');
            const tbQueryList = document.getElementById('tb-query-list');

            if (tbTopicList) {
                if (topics.length === 0) {
                    tbTopicList.innerHTML = `<p class="modal-body" style="text-align: center;">${t('No trends found.')}</p>`;
                } else {
                    tbTopicList.innerHTML = `<ol>${topics.map((trendItem, i) => `<li><span class="rank">${i+1}</span><span class="term">${getLocalizedTrendText(trendItem).title}</span><span class="growth">${t('Rising')}</span></li>`).join('')}</ol>`;
                }
            } else {
                console.error("Missing DOM element: #tb-topic-list");
            }
            
            if (tbQueryList) {
                if (queries.length === 0) {
                    tbQueryList.innerHTML = `<p class="modal-body" style="text-align: center;">${t('No trends found.')}</p>`;
                } else {
                    tbQueryList.innerHTML = `<ol>${queries.map((trendItem, i) => `<li><span class="rank">${i+1}</span><span class="term">${getLocalizedTrendText(trendItem).title}</span><span class="growth">+${Math.floor(Math.random() * 4000)}%</span></li>`).join('')}</ol>`;
                }
            } else {
                console.error("Missing DOM element: #tb-query-list");
            }
        }

        async function renderUserTrendsChart(timeframe) {
            const chartContainer = DOM.userTrendsChartContainer;
            const chartTitleEl = DOM.userTrendsChartTitle;
            const canvas = document.getElementById('user-trends-chart');

            if (!chartContainer || !chartTitleEl || !canvas) {
                console.error("User trends chart elements not found.");
                return;
            }

            if (!user.isLoggedIn || user.accountType !== 'work' || (!user.hasSetPreferences && user.followedTrends.length === 0)) {
                chartContainer.classList.add('hidden');
                return;
            }

            if (userTrendsChart) userTrendsChart.destroy();

            // S·ª≠a ƒë·ªïi quan tr·ªçng: L·ªçc t·ª´ masterTrendsList v√† ch·ªâ √°p d·ª•ng timeframe filter
            let userRelevantTrends = masterTrendsList.filter(trendItem =>
                isTrendRelevantForTimeframe(trendItem, timeframe) && // Apply timeframe filter
                (user.followedTrends.includes(trendItem.id) ||
                (user.preferences.length > 0 && user.preferences.includes(trendItem.category)))
            );

            userRelevantTrends = Array.from(new Set(userRelevantTrends.map(t => t.id)))
                .map(id => masterTrendsList.find(t => t.id === id)) // Re-find from master list to ensure full data
                .filter(Boolean)
                .sort((a, b) => b.hotnessScore - a.hotnessScore);

            const trendsToChart = userRelevantTrends.slice(0, 5);

            if (trendsToChart.length === 0) {
                chartContainer.classList.add('hidden');
                return;
            }

            chartContainer.classList.remove('hidden');
            chartTitleEl.textContent = t('Your Favorite Trends - Interest Over Time');

            const labels = generateChartLabels(timeframe);
            const palette = getColorPalette(trendsToChart.length);

            const datasets = trendsToChart.map((trendItem, idx) => ({
                label: truncateText(getLocalizedTrendText(trendItem).title, 30),
                data: generateSeriesForTimeframe(trendItem, labels, timeframe),
                borderColor: palette[idx].stroke,
                tension: 0.4,
                fill: false,
                pointRadius: 3,
                pointHoverRadius: 5
            }));

            if (datasets.length === 0 || datasets.every(dataset => dataset.data.every(val => val === 0))) {
                chartContainer.classList.add('hidden');
                return;
            }

            userTrendsChart = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#8a8da0', usePointStyle: true, boxWidth: 8 } },
                        tooltip: { callbacks: { label: (ctx) => `${t('Engagement')}: ${formatNumber(ctx.parsed.y)}` } }
                    },
                    scales: {
                        x: { ticks: { color: '#8a8da0' }, grid: { color: 'rgba(255, 255, 255, 0.05)' } },
                        y: { ticks: { color: '#8a8da0', callback: (v) => formatNumber(v) }, beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                    }
                }
            });
        }

        async function createHotTrendsChart(newSearchTerm = null, compareTerm = null) {
            const canvas = document.getElementById('hot-trends-chart');
            if (!canvas) {
                console.error("Missing DOM element: #hot-trends-chart");
                return;
            }
            if (hotTrendsChart) hotTrendsChart.destroy();

            const timeframe = DOM.tbTimeframeFilter ? DOM.tbTimeframeFilter.value : '12m';
            const selectedCategory = DOM.tbCategoryFilter ? DOM.tbCategoryFilter.value : 'All';
            const selectedRegion = DOM.tbRegionFilter ? DOM.tbRegionFilter.value : 'global';

            if (newSearchTerm) {
                const term = newSearchTerm.trim();
                if (term && !user.tbSearchTerms.includes(term)) {
                    user.tbSearchTerms.push(term);
                }
            }
            if (compareTerm) {
                const term = compareTerm.trim();
                if (term && !user.tbSearchTerms.includes(term)) {
                    user.tbSearchTerms.push(term);
                }
            }

            if (DOM.tbSearchChipsContainer) {
                DOM.tbSearchChipsContainer.innerHTML = user.tbSearchTerms.map(term => `
                    <span class="tb-search-chip">${truncateText(term, 20)}
                        <button class="tb-search-chip-remove" data-term="${term}">&times;</button>
                    </span>
                `).join('');
                DOM.tbSearchChipsContainer.classList.toggle('hidden', user.tbSearchTerms.length === 0);
            } else {
                console.error("Missing DOM element: #tb-search-chips-container");
            }

            const chartFilters = {
                region: selectedRegion,
                category: selectedCategory,
                timeframe: timeframe,
            };

            const labels = generateChartLabels(timeframe);
            const datasets = [];
            const palette = getColorPalette(user.tbSearchTerms.length > 0 ? user.tbSearchTerms.length : 5);

            if (user.tbSearchTerms.length > 0) {
                const allFetchedTrendsForSearch = [];
                for (let i = 0; i < user.tbSearchTerms.length; i++) {
                    const term = user.tbSearchTerms[i];
                    const trendsForThisTerm = await fetchLiveTrends({ ...chartFilters, searchTerm: term });
                    allFetchedTrendsForSearch.push(...trendsForThisTerm);
                }

                allTrends = preprocessTrends(allFetchedTrendsForSearch);

                for (let i = 0; i < user.tbSearchTerms.length; i++) {
                    const term = user.tbSearchTerms[i];
                    const trendsForThisSpecificTerm = allTrends.filter(t => getLocalizedTrendText(t).title.toLowerCase().includes(term.toLowerCase()));
                    if (trendsForThisSpecificTerm.length > 0) {
                        const mostRelevantTrend = trendsForThisSpecificTerm.sort((a,b) => b.hotnessScore - a.hotnessScore)[0];
                        datasets.push({
                            label: truncateText(getLocalizedTrendText(mostRelevantTrend).title, 30),
                            data: generateSeriesForTimeframe(mostRelevantTrend, labels, timeframe),
                            borderColor: palette[i].stroke,
                            tension: 0.4,
                            fill: false,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        });
                    }
                }

                if (DOM.tbChartTitle) DOM.tbChartTitle.textContent = t('Interest Over Time');
                if (DOM.tbDefaultView) DOM.tbDefaultView.classList.add('hidden');
            } else {
                allTrends = await fetchLiveTrends(chartFilters); 
                const topTrends = [...allTrends].sort((a, b) => b.hotnessScore - a.hotnessScore).slice(0, 5);
                topTrends.forEach((trendItem, i) => {
                    datasets.push({
                        label: truncateText(getLocalizedTrendText(trendItem).title, 30),
                        data: generateSeriesForTimeframe(trendItem, labels, timeframe),
                        borderColor: palette[i].stroke,
                        tension: 0.4,
                        fill: false,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    });
                });
                
                if (DOM.tbChartTitle) DOM.tbChartTitle.textContent = `${t('Top 5 Hot Trends')} - ${t('Interest Over Time')}`;
                if (DOM.tbDefaultView) DOM.tbDefaultView.classList.remove('hidden');
                renderTBDashboard(timeframe);
            }

            if (datasets.length > 0) {
                hotTrendsChart = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { color: '#8a8da0', usePointStyle: true, boxWidth: 8 } },
                            tooltip: { callbacks: { label: (ctx) => `${t('Engagement')}: ${formatNumber(ctx.parsed.y)}` } }
                        },
                        scales: {
                            x: { ticks: { color: '#8a8da0' }, grid: { color: 'rgba(255, 255, 255, 0.05)' } },
                            y: { ticks: { color: '#8a8da0', callback: (v) => formatNumber(v) }, beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                        }
                    }
                });
            } else {
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                if (DOM.tbChartTitle) DOM.tbChartTitle.textContent = t('No trends found.');
            }

            // NEW: Render the user's favorite trends chart after the main chart
            renderUserTrendsChart(timeframe);
        }
        // --- End Trending Board specific functions ---

        function handleInteraction(e) {
            const targetElement = e.target;
            const trendCard = targetElement.closest('.trend-card');
            const leaderboardItem = targetElement.closest('.leaderboard-widget li');
            
            let trendId = trendCard?.dataset.trendId || leaderboardItem?.dataset.trendId; 
            let trend = masterTrendsList.find(trendItem => trendItem.id === trendId);
            
            if (trend) {
                if (targetElement.closest('.btn-follow')) {
                    if (!user.isLoggedIn || user.accountType !== 'work') return openModal('premium-modal');
                    
                    const isFollowed = user.followedTrends.includes(trend.id);
                    user.followedTrends = isFollowed ? user.followedTrends.filter(id => id !== trend.id) : [...user.followedTrends, trend.id];
                    
                    const renderedCard = document.querySelector(`.trend-card[data-trend-id="${trend.id}"]`);
                    if(renderedCard) {
                        const followBtn = renderedCard.querySelector('.btn-follow');
                        followBtn.classList.toggle('followed', !isFollowed);
                        followBtn.textContent = !isFollowed ? t('Following') : t('‚ù§Ô∏è Follow');
                    }
                    
                    if (currentView === 'forU') { 
                        generateCategoryLeaderboards('for-u-leaderboards', user.preferences); 
                    }
                    if (currentView === 'trendingBoard') {
                        // Re-render both charts, as user trends chart might also change
                        createHotTrendsChart(); // This will also call renderUserTrendsChart
                    }
                } else if (targetElement.closest('.analyze-trend-btn') || targetElement.closest('.trend-title') || leaderboardItem) {
                    if (!user.isLoggedIn || user.accountType !== 'work') return openModal('premium-modal');
                    const isSummary = !!targetElement.closest('.analyze-trend-btn');
                    const analysisType = isSummary ? 'summary' : 'detailed';
                    const titleKey = isSummary ? 'AI Analysis Summary for' : 'AI Deep Dive for';
                    
                    const { title: localizedTrendTitle } = getLocalizedTrendText(trend);
                    document.getElementById('ai-insight-title').textContent = `${t(titleKey)} "${truncateText(localizedTrendTitle, 20)}"`;
                    const modalBody = document.getElementById('ai-insight-body');
                    if (!modalBody) return;
                    modalBody.classList.remove('error-message');
                    modalBody.innerHTML = `<div class="loading-spinner"></div><p style="text-align:center; margin-top:1rem;">${t('Analyzing trend...')}</p>`;
                    openModal('ai-insight-modal');
                    analyzeTrendSecurely(trend, analysisType).then(data => {
                        if (isSummary) { renderSummaryAnalysis(data); }
                        else { renderDetailedAnalysis(data); }
                    }).catch(err => {
                        if (modalBody) {
                            modalBody.classList.add('error-message');
                            modalBody.innerHTML = `<p style="text-align: center;">${t('Unable to analyze trend.')}<br><small style="color: var(--text-muted-color);">${DOMPurify.sanitize(err.message)}</small></p>`;
                        }
                    });
                } else if (targetElement.matches('.tag.hashtag')) {
                    currentFilter.type = 'hashtag';
                    currentFilter.value = 'All'; // Reset category filter when hashtag is selected
                    currentFilter.hashtag = targetElement.dataset.tag;
                    currentFilter.searchTerm = ''; // Clear search term
                    switchView('main'); // Always switch to main view to apply general filters
                }
            } else if (targetElement.matches('.tag.hashtag')) { // Handle hashtag click even if not on a trend card
                currentFilter.type = 'hashtag';
                currentFilter.value = 'All';
                currentFilter.hashtag = targetElement.dataset.tag;
                currentFilter.searchTerm = '';
                switchView('main');
            }
        }

            async function initializeApp() {
                applyTranslations();
                updateLanguageToggleUI();

                if (DOM.mainViewContainer) DOM.mainViewContainer.classList.toggle('hidden', currentView !== 'main');
                if (DOM.forUViewContainer) DOM.forUViewContainer.classList.toggle('hidden', currentView !== 'forU');
                if (DOM.trendingBoardViewContainer) DOM.trendingBoardViewContainer.classList.toggle('hidden', currentView !== 'trendingBoard');

                // Initial fetch of master trends list (12 months, all regions, all categories)
                // This list will be the comprehensive source for all UI parts.
                masterTrendsList = await fetchLiveTrends({ timeframe: '12m', region: 'global', category: 'All' }); 
                
                applyTrendOrdering(); // Order the master list based on 'seen' status

                // Populate categories based on the full master list
                categories = [...new Set(masterTrendsList.map(trendItem => trendItem.category))].sort();
                populateCategoryFilters();
                populateHashtagFilters();
                
                updateAuthUI();
                checkAIStatus();
                updateActiveNav(currentView);
                updateClearFilterButtonVisibility();

                // If starting on TB, we need to filter masterTrendsList according to TB filters
                if (currentView === 'trendingBoard') {
                    const tbFilters = {
                        region: DOM.tbRegionFilter ? DOM.tbRegionFilter.value : 'global',
                        category: DOM.tbCategoryFilter ? DOM.tbCategoryFilter.value : 'All',
                        timeframe: DOM.tbTimeframeFilter ? DOM.tbTimeframeFilter.value : '12m',
                    };
                    // `allTrends` here will be the *filtered subset* for the main TB view.
                    // This is used for rendering `tb-leaderboards-grid` and `hot-trends-chart`.
                    allTrends = masterTrendsList.filter(trend => 
                        (tbFilters.region === 'global' || trend.region === tbFilters.region) &&
                        (tbFilters.category === 'All' || trend.category === tbFilters.category) &&
                        isTrendRelevantForTimeframe(trend, tbFilters.timeframe)
                    );
                    await createHotTrendsChart(); // Call chart creation, which uses allTrends (for top 5) and masterTrendsList (for user trends)
                } else {
                    displayTrends(); // Display trends for main/forU view (uses masterTrendsList)
                }

                document.getElementById('loader')?.classList.add('loader-hidden');
            }

            if (DOM.hamburgerMenu) DOM.hamburgerMenu.addEventListener('click', () => { if (DOM.mainNav) DOM.mainNav.classList.toggle('nav-active'); });
            if (DOM.logo) DOM.logo.addEventListener('click', () => switchView('main'));
            if (DOM.navTopTrends) DOM.navTopTrends.addEventListener('click', (e) => { e.preventDefault(); switchView('main'); });
            if (DOM.navForU) DOM.navForU.addEventListener('click', (e) => { e.preventDefault(); switchView('forU'); });
            if (DOM.signInBtn) DOM.signInBtn.addEventListener('click', () => openModal('login-choice-modal'));
            if (DOM.userEmailBtn) DOM.userEmailBtn.addEventListener('click', () => { if (DOM.userDropdown) DOM.userDropdown.classList.toggle('show'); });
            if (DOM.dropdownSignOut) DOM.dropdownSignOut.addEventListener('click', () => {
                user = { isLoggedIn: false, email: null, accountType: null, preferences: [], hasSetPreferences: false, followedTrends: [], tbSearchTerms: [] };
                updateAuthUI();
                if (DOM.userDropdown) DOM.userDropdown.classList.remove('show');
                switchView('main');
            });
            if (DOM.dropdownWorkSchool) DOM.dropdownWorkSchool.addEventListener('click', () => {
                 signIn('work');
                 if (DOM.userDropdown) DOM.userDropdown.classList.remove('show');
            });
            if (DOM.navAbout) DOM.navAbout.addEventListener('click', (e) => { e.preventDefault(); openModal('about-modal'); updateActiveNav('about'); });
            if (DOM.navTrendingBoard) DOM.navTrendingBoard.addEventListener('click', (e) => { e.preventDefault(); if (user.isLoggedIn && user.accountType === 'work') { switchView('trendingBoard'); } else { openModal('premium-modal'); } });
            document.getElementById('premium-login-btn')?.addEventListener('click', () => { closeModal('premium-modal'); openModal('login-choice-modal'); });
            DOM.modalCloses.forEach(btn => btn.addEventListener('click', () => {
                closeModal(btn.closest('.modal-overlay').id);
                const modalId = btn.closest('.modal-overlay').id;
                if (modalId !== 'about-modal') {
                    updateActiveNav(currentView);
                }
            }));
            document.getElementById('login-google-btn')?.addEventListener('click', () => signIn('personal'));
            document.getElementById('login-work-btn')?.addEventListener('click', () => signIn('work'));
            if (DOM.loadMoreBtn) DOM.loadMoreBtn.addEventListener('click', loadMoreTrends);
            if (DOM.forULoadMoreBtn) DOM.forULoadMoreBtn.addEventListener('click', loadMoreTrends);
            if (DOM.savePreferencesBtn) DOM.savePreferencesBtn.addEventListener('click', () => {
                user.preferences = [...document.querySelectorAll('#preferences-grid input:checked')].map(cb => cb.value);
                user.hasSetPreferences = true;
                closeModal('preferences-modal');
                switchView('forU');
            });

            [DOM.trendsList, DOM.forUTrendsList, document.getElementById('for-u-leaderboards')].forEach(list => {
                if (list) list.addEventListener('click', handleInteraction);
            });

            if (DOM.filterButtonsContainer) DOM.filterButtonsContainer.addEventListener('click', async (e) => {
                if (e.target.matches('.filter-btn')) {
                    currentFilter.type = 'category';
                    currentFilter.value = e.target.dataset.filter;
                    currentFilter.hashtag = '';
                    if (DOM.hashtagList) DOM.hashtagList.querySelectorAll('.hashtag-btn').forEach(btn => btn.classList.remove('active'));

                    // No need to fetch, just re-filter and update UI
                    updateUIForFilter();
                }
            });
            if (DOM.clearFilterBtn) DOM.clearFilterBtn.addEventListener('click', clearMainViewFilters);

            const debouncedSearch = debounce(async () => {
                currentFilter.searchTerm = DOM.searchInput ? DOM.searchInput.value : '';
                // No need to fetch, just re-filter and update UI
                displayedTrends.main = 0;
                displayTrends();
            }, 300);
            if (DOM.searchInput) DOM.searchInput.addEventListener('input', debouncedSearch);

            if (DOM.hashtagList) DOM.hashtagList.addEventListener('click', async (e) => {
                if (e.target.matches('.hashtag-btn')) {
                    const hashtag = e.target.dataset.hashtag;
                    if (currentFilter.hashtag === hashtag) {
                        currentFilter.hashtag = '';
                    } else {
                        currentFilter.hashtag = hashtag;
                    }
                    currentFilter.type = 'hashtag';
                    currentFilter.value = 'All';
                    if (DOM.filterButtonsContainer) DOM.filterButtonsContainer.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));

                    // No need to fetch, just re-filter and update UI
                    displayedTrends.main = 0;
                    displayTrends();
                    updateUIForFilter();
                }
            });

            if (DOM.tbSearchInput) DOM.tbSearchInput.addEventListener('keypress', async function(e) {
                if (e.key === 'Enter' && this.value.trim() !== '') {
                    await createHotTrendsChart(this.value.trim());
                    this.value = '';
                }
            });

            if (DOM.tbCompareInput) DOM.tbCompareInput.addEventListener('keypress', async function(e) {
                if (e.key === 'Enter' && this.value.trim() !== '') {
                    await createHotTrendsChart(null, this.value.trim());
                    this.value = '';
                }
            });

            if (DOM.tbSearchChipsContainer) DOM.tbSearchChipsContainer.addEventListener('click', async function(e) {
                if (e.target.classList.contains('tb-search-chip-remove')) {
                    const termToRemove = e.target.dataset.term;
                    user.tbSearchTerms = user.tbSearchTerms.filter(term => term !== termToRemove);
                    await createHotTrendsChart();
                }
            });

            // These event listeners now trigger `createHotTrendsChart` which internally fetches new data
            if (DOM.tbCategoryFilter) DOM.tbCategoryFilter.addEventListener('change', () => createHotTrendsChart());
            if (DOM.tbTimeframeFilter) DOM.tbTimeframeFilter.addEventListener('change', () => createHotTrendsChart());
            if (DOM.tbRegionFilter) DOM.tbRegionFilter.addEventListener('change', () => createHotTrendsChart());

            document.addEventListener('click', (e) => {
                if (DOM.userMenu && DOM.userDropdown && !DOM.userMenu.contains(e.target)) {
                    DOM.userDropdown.classList.remove('show');
                }
                if (DOM.mainNav && DOM.hamburgerMenu && DOM.mainNav.classList.contains('nav-active') && !DOM.mainNav.contains(e.target) && !DOM.hamburgerMenu.contains(e.target)) {
                     DOM.hamburgerMenu.click();
                }
            });

            document.getElementById('language-toggle')?.addEventListener('click', async () => {
                currentLanguage = currentLanguage === 'vi' ? 'en' : 'vi';
                localStorage.setItem('lang', currentLanguage);
                applyTranslations();
                updateLanguageToggleUI();
                
                // When language changes, refetch master list to ensure category names are updated
                masterTrendsList = await fetchLiveTrends({ timeframe: '12m', region: 'global', category: 'All' }, true); // Force refetch
                applyTrendOrdering(); // Re-order after refetching

                categories = [...new Set(masterTrendsList.map(trendItem => trendItem.category))].sort();
                populateCategoryFilters();
                populateHashtagFilters();

                if (currentView === 'trendingBoard') {
                    await createHotTrendsChart();
                } else {
                    displayTrends();
                }
            });

            initializeApp();
        });
    </script>
</body>
</html>
